//---------------------------------------------------------------------------

#include <fmx.h>
#include <FMX.Platform.Win.hpp>
#include <IOUtils.hpp>
#pragma hdrstop

#include "Sobre.h"
#include "Carregar.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.fmx"
#pragma resource ("*.Windows.fmx", _PLAT_MSWINDOWS)
String novo, arq;
int temp = 0;
bool Estado = false;
TfrmSobre *frmSobre;
//---------------------------------------------------------------------------
__fastcall TfrmSobre::TfrmSobre(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::btAtualizarClick(TObject *Sender)
{
	lblEstado->Text = "Verificando atualizações...";
	frmSobre->Height += 53;
	btAtualizar->Position->Y += 53;
	btSite->Position->Y += 53;
	btFacebook->Position->Y += 53;
	barraEstado->Visible = true;
	lblEstado->Visible = true;
	Indicador->Visible = true;
	Controle->Enabled = true;
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::btSiteClick(TObject *Sender)
{
	ShellExecuteA( NULL, "open", "http://www.nintersoft.ml/", NULL, NULL, SW_SHOW );
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::btFacebookClick(TObject *Sender)
{
	ShellExecuteA( NULL, "open", "http://www.facebook.com/Nintersoft", NULL, NULL, SW_SHOW );
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::btAtualizarMouseDown(TObject *Sender, TMouseButton Button,
		  TShiftState Shift, float X, float Y)
{
	btAtualizar->Fill->Color = -12525360;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btSiteMouseDown(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  float X, float Y)
{
	btSite->Fill->Color = -12525360;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btFacebookMouseDown(TObject *Sender, TMouseButton Button,
		  TShiftState Shift, float X, float Y)
{
	btFacebook->Fill->Color = -12525360;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btAtualizarMouseLeave(TObject *Sender)
{
	btAtualizar->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btAtualizarMouseUp(TObject *Sender, TMouseButton Button,
		  TShiftState Shift, float X, float Y)
{
	btAtualizar->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btSiteMouseLeave(TObject *Sender)
{
	btSite->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btSiteMouseUp(TObject *Sender, TMouseButton Button, TShiftState Shift,
		  float X, float Y)
{
	btSite->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btFacebookMouseLeave(TObject *Sender)
{
	btFacebook->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::btFacebookMouseUp(TObject *Sender, TMouseButton Button,
		  TShiftState Shift, float X, float Y)
{
	btFacebook->Fill->Color = -16777011;
}
//---------------------------------------------------------------------------
void TfrmSobre::Principal()
{
	try {
		String LOC = System::Ioutils::TPath::Combine(frmCarregar->NSNPLOCATL, L"NSATL.txt");
		TFileStream* arquivo = new TFileStream(LOC, fmCreate);
		Application->ProcessMessages();
		gerWebArq->Get(L"https://docs.google.com/uc?id=0BxyKD6Pyuhy4ajJPMFVlajZXQkE&export=download", arquivo);
		delete arquivo;
		mmDados->BeginUpdate();
		mmDados->Lines->LoadFromFile(LOC);
		mmDados->EndUpdate();
		TFile::Delete(LOC);
	} catch (...) {
		lblEstado->Text = L"Erro";
		frmSobre->Height -= 53;
		btAtualizar->Position->Y -= 53;
		btSite->Position->Y -= 53;
		btFacebook->Position->Y -= 53;
		barraEstado->Visible = false;
		lblEstado->Visible = false;
		Indicador->Visible = false;
		throw Exception (L"Algum erro ocorreu durante a busca por atualizações...\nHouve um erro de conexão com o servidor");
	}
	if (!Atualizado()) {
		ShowMessage(L"Seu Ninterpres já encontra-se atualizado!");
	}
	else {
		AdquirirNomes();
		lblEstado->Text = novo;
		Estado = true;
		Sleep(5000);
		try {
			String LOC = System::Ioutils::TPath::Combine(frmCarregar->NSNPLOCATL, L"INPS.exe");
			TFileStream* arquivo = new TFileStream(LOC, fmCreate);
			Application->ProcessMessages();
			download->Get(arq, arquivo);
			delete arquivo;
			novo = "Adquirindo ";
			Sleep(2000);
			ShowMessage(L"Atenção: A aplicação será encerrada e o instalador será iniciado.");
			ShellExecuteW( NULL, L"open", LOC.c_str(), NULL, NULL, SW_SHOW );
			Application->Terminate();
		} catch (...) {
			frmSobre->Height -= 53;
			btAtualizar->Position->Y -= 53;
			btSite->Position->Y -= 53;
			btFacebook->Position->Y -= 53;
			barraEstado->Visible = false;
			lblEstado->Visible = false;
			Indicador->Visible = false;
			lblEstado->Text = L"Erro";
			novo = "Adquirindo ";
			throw Exception (L"Algum erro ocorreu enquanto baixavamos as atualizações...\nVocê está certo de que está conectado à internet?");
		}
	}

	frmSobre->Height -= 53;
	btAtualizar->Position->Y -= 53;
	btSite->Position->Y -= 53;
	btFacebook->Position->Y -= 53;
	barraEstado->Visible = false;
	lblEstado->Visible = false;
	Indicador->Visible = false;
}
//---------------------------------------------------------------------------
void TfrmSobre::AdquirirNomes()
{
	String linha = mmDados->Lines->Strings[0];
	int num = 0;
	for (int i = 0; i < linha.Length(); i++) {
		if (num < 1) {
			if (linha.c_str()[i] == '=') {
				num ++;
			}
			else {
				novo = novo + linha.c_str()[i];
			}
		}
		else if (num >= 1 && num < 4) {
			if (linha.c_str()[i] == '=') {
				num++;
				if (num < 4) {
					arq = arq + linha.c_str()[i];
				}
			}
			else {
				arq = arq + linha.c_str()[i];
			}
		}
	}
}
//---------------------------------------------------------------------------
bool TfrmSobre::Atualizado()
{
	String ver, linha = mmDados->Lines->Strings[0];
	int num = 0;
	for (int i = 0; i < linha.Length(); i++) {
		if (num < 4) {
			if (linha.c_str()[i] == '=') {
				num ++;
			}
		}
		else {
			ver = ver + linha.c_str()[i];
		}
	}
	if (StrToInt(ver) <= verat)	return true;
	else return false;
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::FormCreate(TObject *Sender)
{
	HWND hWnd = Fmx::Platform::Win::FormToHWND(frmSobre);
	if (hWnd != NULL)
	{
		LONG Style = GetWindowLong(hWnd, GWL_EXSTYLE);
		SetWindowLong(hWnd, GWL_EXSTYLE, Style | WS_EX_APPWINDOW);
	}
	verat = 1;
	novo = "Adquirindo ";
	arq = "";
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::ControleTimer(TObject *Sender)
{
	if (temp < 1) temp++;
	else {
		temp = 0;
		Controle->Enabled = false;
		Principal();
	}
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::FormShow(TObject *Sender)
{
	HWND hWnd = Fmx::Platform::Win::FormToHWND(frmSobre);
	if (hWnd != NULL)
	{
		LONG Style = GetWindowLong(hWnd, GWL_EXSTYLE);
		SetWindowLong(hWnd, GWL_EXSTYLE, Style | WS_EX_APPWINDOW);
	}
}
//---------------------------------------------------------------------------
void __fastcall TfrmSobre::downloadWorkBegin(TObject *ASender, TWorkMode AWorkMode,
		  __int64 AWorkCountMax)
{
	barraEstado->Value = 0;
	barraEstado->Max = AWorkCountMax;
}
//---------------------------------------------------------------------------

void __fastcall TfrmSobre::downloadWork(TObject *ASender, TWorkMode AWorkMode, __int64 AWorkCount)

{
	barraEstado->Value = AWorkCount;
	Application->ProcessMessages();
}
//---------------------------------------------------------------------------

