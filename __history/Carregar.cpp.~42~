//---------------------------------------------------------------------------

#include <fmx.h>
// #include <FMX.Platform.Win.hpp>
#include <IOUtils.hpp>
#include <shlobj.h>
#pragma hdrstop

#include "Carregar.h"
#include "Principal.h"
#include "Codigo.h"
#include "Configuracoes.h"
#include "Sobre.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.fmx"
TfrmCarregar *frmCarregar;
//---------------------------------------------------------------------------
int cont = 0;
//---------------------------------------------------------------------------
__fastcall TfrmCarregar::TfrmCarregar(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------
void __fastcall TfrmCarregar::tmConfigurarTimer(TObject *Sender)
{
	if (cont == 0) {

	lblEstado->Text = "Lendo arquivos...";

	PWSTR pszPath;
	if (SUCCEEDED(SHGetKnownFolderPath(FOLDERID_RoamingAppData, 0, NULL, &pszPath)))
	{
		String NSNPTEMP = System::Ioutils::TPath::Combine(pszPath, L"Nintersoft\\Ninterpres\\TEMP");
		NSNPLOC = System::Ioutils::TPath::Combine(pszPath, L"Nintersoft\\Ninterpres");
		NSNPLOCATL = System::Ioutils::TPath::Combine(NSNPLOC, L"NSNPATL");

		if (!TDirectory::Exists(NSNPTEMP)) TDirectory::CreateDirectory(NSNPTEMP);
		if (!TDirectory::Exists(NSNPLOCATL)) TDirectory::CreateDirectory(NSNPLOCATL);

		String NSNA = System::Ioutils::TPath::Combine(NSNPTEMP, L"NSTEMP.nps");
		if (TFile::Exists(NSNA)){
			TFile::Delete(NSNA);
		}

		NSNPCONF = System::Ioutils::TPath::Combine(pszPath, L"Nintersoft\\Ninterpres\\Config");
		CoTaskMemFree(pszPath);

		if (!TDirectory::Exists(NSNPCONF)) {
			TDirectory::CreateDirectory(NSNPCONF);
		}

	}

		cont ++;

	}
	else if (cont == 1) {

		lblEstado->Text = "Gerando arquivo inicial...";

		String arq = System::Ioutils::TPath::Combine(NSNPLOC, L"NSNV");

		if (!TFile::Exists(arq+".nps")) {
			frmCodigo->mmCodigo->Lines->SaveToFile(arq+".nps");
		}

		cont++;

	}

	else if (cont == 2) {

		lblEstado->Text = "Aplicando configurações do usuário...";

		String NSNPARQCONF = System::Ioutils::TPath::Combine(NSNPCONF, L"CONF");

		if (TFile::Exists(NSNPARQCONF+".conf")) {

			frmConfig->mmConfig->Lines->LoadFromFile(NSNPARQCONF+".conf");

			if (frmConfig->mmConfig->Lines->Count < 15) {
				ShowMessage("ERRO 001000: Arquivo de configuração corrompido excluído.\nConfigurações padrões serão utilizadas.\nOperação de carregamento de configurações cancelada.");
				falha:
				TFile::Delete(NSNPARQCONF+".conf");
			}
			else {
				try {
					TfrmCarregar::AplicarConfig();
				} catch (...) {
					ShowMessage("ERRO 001001: Erro durante a aplicação das configurações.\nAs configurações serão restauradas à seus padrões.");
					goto falha;
				}
			}

		}

		cont++;

	}

	else {

		lblEstado->Text = "Carregando...";

		Application->MainForm->Show();
		tmConfigurar->Enabled = false;
		frmCarregar->Close();

	}
}
//---------------------------------------------------------------------------
void __fastcall TfrmCarregar::btFecharClick(TObject *Sender)
{
	Application->Terminate();
}
//---------------------------------------------------------------------------
void __fastcall TfrmCarregar::FormCreate(TObject *Sender)
{
/*	HWND hWnd = FormToHWND(frmCarregar);
	if (hWnd != NULL)
	{
		LONG Style = GetWindowLong(hWnd, GWL_EXSTYLE);
		SetWindowLong(hWnd, GWL_EXSTYLE, Style | WS_EX_APPWINDOW);
	}
*/
}
//---------------------------------------------------------------------------
void TfrmCarregar::AplicarConfig()
{

	//---------------------------- Editor -----------------------------------

	if (frmConfig->mmConfig->Lines->Strings[0] == "NSEDT") {
		frmConfig->cbAtivarEditor->IsChecked = true;
		frmCodigo->mmCodigo->ReadOnly = false;
	}
	else if (frmConfig->mmConfig->Lines->Strings[0] == "!NSEDT") {
		frmConfig->cbAtivarEditor->IsChecked = false;
		frmCodigo->mmCodigo->ReadOnly = true;
	}
	else {
		throw Exception ("ERRO 001001: Erro durante a aplicação das configurações.\nAs configurações serão restauradas à seus padrões.");
	}

	//---------------------------- Nome ------------------------------------

	frmSobre->lblLicencProg->Text = frmConfig->mmConfig->Lines->Strings[13];

	//--------------------------- Idioma -----------------------------------

	int Idioma = StrToInt(frmConfig->mmConfig->Lines->Strings[14]);
	frmConfig->cbSelecIdioma->ItemIndex = Idioma;

	if (Idioma == 0) {
		frmPrincipal->Idioma->Lang = "pt";
	}
	else {
		throw Exception ("ERRO 001001: Erro durante a aplicação das configurações.\nAs configurações serão restauradas à seus padrões.");
	}

	//--------------------------- Marcação ---------------------------------

	frmConfig->cbDefPad->IsChecked = true;

}
//---------------------------------------------------------------------------
